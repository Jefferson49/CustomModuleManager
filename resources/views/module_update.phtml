<?php

declare(strict_types=1);

use Fisharebest\Webtrees\Http\RequestHandlers\ControlPanel;
use Fisharebest\Webtrees\Module\ModuleCustomInterface;
use Fisharebest\Webtrees\Module\ModuleThemeInterface;
use Fisharebest\Webtrees\Services\ModuleService;
use Fisharebest\Webtrees\I18N;
use Jefferson49\Webtrees\Module\CustomModuleManager\RequestHandlers\ModuleUpgradeWizardPage;
use Jefferson49\Webtrees\Module\CustomModuleManager\ModuleUpdates\AbstractModuleUpdate;

/**
 * @var string $title
 */


$module_service = New ModuleService();
$custom_modules = $module_service->findByInterface(ModuleCustomInterface::class, true);
$themes         = $module_service->findByInterface(ModuleThemeInterface::class, true);

$module_update_config = [
	'_change_language_with_url_'      =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'Jefferson49/ChangeLanguageWithURL']],
	'_extended_import_export_'        =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'Jefferson49/ExtendedImportExport']],
	'_oauth2_client_'                 =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'Jefferson49/webtrees-oauth2-client']],
	'_repository_hierarchy_'          =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'Jefferson49/RepositoryHierarchy']],

	'_jc-fancy-imagebar'              =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'JustCarmen/webtrees-fancy-imagebar']],
	'_jc-fancy-research-links_'       =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'JustCarmen/webtrees-fancy-research-links']],
	'_jc-fancy-treeview_'             =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'JustCarmen/webtrees-fancy-treeview']],
	'_webtrees-simple-footer_'        =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'JustCarmen/webtrees-simple-footer']],
	'_webtrees-simple-media-display_' =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'JustCarmen/webtrees-simple-media-display']],
	'_webtrees-simple-menu_'          =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'JustCarmen/webtrees-simple-menu']],
	'_jc-theme-justlight_'            =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'JustCarmen/webtrees-theme-justlight']],    

    '_webtrees-primer-theme_'         =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'ekdahl/webtrees-primer-theme']],

    '_GVExport_'                      =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'Neriderc/GVExport']],

	'_webtrees-descendants-chart_'    =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'magicsunday/webtrees-descendants-chart']],
    '_webtrees-fan-chart_'            =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'magicsunday/webtrees-fan-chart']],
	'_webtrees-pedigree-chart_'       =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'magicsunday/webtrees-pedigree-chart']],

	'_myartjaub_ruraltheme_'          =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'jon48/webtrees-theme-rural']],

	'_huhwt-cce_'                     =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'huhwt/huhwt-cce']],
	'_huhwt-xtv_'                     =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'huhwt/huhwt-xtv']],
	'_huhwt-wttam_'                   =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'huhwt/huhwt-wttam']],
	'_huhwt-wtlin_'                   =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'huhwt/huhwt-wtlin']],
	'_huhwt-tsm_'                     =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'huhwt/huhwt-tsm']],
	'_huhwt-mtv_'                     =>  ['update_service' => 'GithubModuleUpdate', 'params' => ['github_repo' => 'huhwt/huhwt-mtv']],

    '_vesta_classic_look_and_feel_'   =>  ['update_service' => 'VestaModuleUpdate', 'params' => ['github_repo' => 'vesta-webtrees-2-custom-modules/vesta_classic_laf']],
    '_vesta_clippings_cart_'          =>  ['update_service' => 'VestaModuleUpdate', 'params' => []],
    '_vesta_common_'                  =>  ['update_service' => 'VestaModuleUpdate', 'params' => []],
    '_vesta_extended_relationships_'  =>  ['update_service' => 'VestaModuleUpdate', 'params' => ['github_repo' => 'vesta-webtrees-2-custom-modules/vesta_extended_relationships']],
    '_vesta_personal_facts_'          =>  ['update_service' => 'VestaModuleUpdate', 'params' => []],
    '_vesta_relatives_'               =>  ['update_service' => 'VestaModuleUpdate', 'params' => []],
    '_vesta_gov4webtrees_'            =>  ['update_service' => 'VestaModuleUpdate', 'params' => ['github_repo' => 'vesta-webtrees-2-custom-modules/vesta_gov4webtrees']],
    '_vesta_places_and_pedigree_map_' =>  ['update_service' => 'VestaModuleUpdate', 'params' => []],
    '_vesta_research_suggestions_'    =>  ['update_service' => 'VestaModuleUpdate', 'params' => ['github_repo' => 'vesta-webtrees-2-custom-modules/vesta_research_suggestions']],
    '_vesta_shared_places_'           =>  ['update_service' => 'VestaModuleUpdate', 'params' => ['github_repo' => 'vesta-webtrees-2-custom-modules/vesta_shared_places']],
    '_vesta_location_data_'           =>  ['update_service' => 'VestaModuleUpdate', 'params' => []],
];

?>

<?= view('components/breadcrumbs', ['links' => [route(ControlPanel::class) => I18N::translate('Control panel'), $title]]) ?>

<h1><?= $title ?></h1>

<div class="row mb-3"><?= view('icons/spacer') ?></div>

<table
    class="table table-bordered table-sm wt-table-module-updates datatables d-none"
    <?= view('lists/datatables-attributes') ?>
    data-columns="<?= e(json_encode([
        ['type' => 'html'],
        null,
        ['searchable' => false],
        null,
        null,
        ['searchable' => false],
        ['type' => 'html', 'searchable' => false],
    ], JSON_THROW_ON_ERROR)) ?>"
>
    <caption class="visually-hidden">
        <?= $caption ?? I18N::translate('Module Updates') ?>
    </caption>

    <thead>
        <tr>
            <th><?= I18N::translate('Title') ?></th>
            <th><?= I18N::translate('Folder (within modules_v4)') ?></th>
            <th><?= I18N::translate('Theme') ?></th>
            <th><?= I18N::translate('Current Version') ?></th>
            <th><?= I18N::translate('Latest Version') ?></th>
            <th><?= I18N::translate('Update Service') ?></th>
            <th><?= I18N::translate('Update') ?></th>
        </tr>
    </thead>

    <tbody>
        <?php foreach ($custom_modules as $module) : ?>
            <tr>
                <!-- Title -->
                <td data-sort="<?= e($module->title()) ?>">
					<?= e($module->title()) ?>
                </td>

                <!-- Folder -->
				<?php $installation_folder = AbstractModuleUpdate::getInstallationFolderFromModuleName($module->name()) ?>
                <td data-sort="<?= e($installation_folder) ?>">
					<?= e($installation_folder) ?>
                </td>

                <!-- Theme -->
				<?php $is_theme = $themes->contains($module) ?>			
                 <td class="text-center" data-sort="<?= $is_theme === true ? '1' : '0' ?>">
					<?php if ($is_theme) : ?>
						<?= I18N::translate('yes') ?>
					<?php endif ?>						
                </td>

                <!-- Current version -->
				<?php $current_version = $module->customModuleVersion() ?>
                <td data-sort="<?= e($current_version) ?>">
                	<?= e($current_version) ?>
                </td>

                <!-- Latest version -->
				<?php $latest_version = $module->customModuleLatestVersion() ?>
                <td data-sort="<?= e($latest_version) ?>">
                	<?= e($latest_version) ?>
                </td>

                <!--Update service available-->
				<?php $update_service_available = array_key_exists($module->name(), $module_update_config) ?>
                <td class="text-center" data-sort="<?= $update_service_available === true ? '1' : '0' ?>">
					<?php if ($update_service_available) : ?>
						<?= I18N::translate('yes') ?>
					<?php endif ?>						
                </td>

                <!--Update -->
				<?php $update = version_compare($latest_version, $current_version) > 0; ?>
                <td data-sort="<?= $update === true ? '1' : '0' ?>">
					<?php if ($update && array_key_exists($module->name(), $module_update_config)) : ?>
						<a href="<?= e(route(ModuleUpgradeWizardPage::class, [
								'update_service' => $module_update_config[$module->name()]['update_service'],
								'module_name'    => $module->name(),
								'params'         => $module_update_config[$module->name()]['params'],
							])) ?>" type="submit" class="btn btn-secondary">
							<?= I18N::translate('Update module') ?>
						</a>
					<?php endif ?>						
                </td>
            </tr>
        <?php endforeach ?>
    </tbody>
</table>
